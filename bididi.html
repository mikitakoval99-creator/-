<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú–µ–Ω—é –†–µ–∂–∏–º–æ–≤: –ü–∞—Ä–∫—É—Ä, –ö–ª–∏–∫–µ—Ä, –†–µ–¥–∞–∫—Ç–æ—Ä, –§–µ—Ä–º–∞, –ë–ª–æ–≥–µ—Ä (–ì—Ä–∞—Ñ–∏–∫–∞ 2.0)</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; background: #333; }
        
        /* --- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ –ò –°–¢–ê–†–¢–û–í–´–ô –≠–ö–†–ê–ù --- */
        #menu-container, #ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            background: rgba(0, 0, 0, 0.9); z-index: 200;
        }
        #menu-box {
            text-align: center; color: white;
            background: linear-gradient(135deg, #1e90ff, #00bfff); padding: 50px; 
            border-radius: 20px; border: 4px solid white;
            box-shadow: 0 0 40px black;
        }
        .mode-button {
            display: block; width: 250px; padding: 15px; margin: 20px auto;
            font-size: 24px; cursor: pointer; border: none; border-radius: 10px;
            background: #FFD700; color: #333; font-weight: bold;
            transition: transform 0.1s;
        }
        .mode-button:hover {
            transform: scale(1.05);
            background: #FFEB3B;
        }

        /* --- –û–ë–©–ò–ï –°–¢–ò–õ–ò –î–õ–Ø –í–ï–†–ù–£–¢–¨–°–Ø –í –ú–ï–ù–Æ --- */
        .back-to-menu {
            position: absolute; top: 10px; left: 10px;
            padding: 10px; background: #F44336; color: white;
            border-radius: 5px; cursor: pointer; z-index: 160;
        }
        
        /* --- UI –ü–ê–†–ö–£–†–ê --- */
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 10px; height: 10px;
            background: white; border-radius: 50%; transform: translate(-50%, -50%);
            pointer-events: none; z-index: 5;
            display: none;
        }
        #trophy-message {
            position: absolute; top: 10%; width: 100%; text-align: center;
            color: gold; font-size: 40px; text-shadow: 0 0 10px black; display: none;
            z-index: 100;
        }
        #admin-fly-button {
            position: absolute; top: 10px; left: 10px; 
            padding: 8px 15px; background: rgba(0, 0, 0, 0.7); 
            color: white; border: 2px solid #1e90ff; 
            cursor: pointer; z-index: 100;
            border-radius: 5px; display: none;
        }

        /* --- UI –ö–õ–ò–ö–ï–†–ê --- */
        #clicker-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none;
            flex-direction: column; align-items: center; justify-content: center;
            background-color: #4CAF50; color: white; z-index: 150;
        }
        #click-count { font-size: 80px; font-weight: bold; margin-bottom: 20px; }
        #click-button {
             width: 250px; height: 250px; border-radius: 50%; 
            background: #FF9800; border: 10px solid #FFC107;
            font-size: 36px; cursor: pointer; color: white;
            transition: transform 0.1s, background 0.1s;
            margin-bottom: 30px;
            box-shadow: 0 10px 0 #E65100;
        }
        .upgrade-button {
            padding: 10px 20px; margin: 10px; font-size: 20px;
            border-radius: 5px; cursor: pointer; border: none;
            background: #2196F3; color: white;
            transition: background 0.1s;
        }

        /* --- UI –†–ï–î–ê–ö–¢–û–†–ê --- */
        #editor-ui { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none;
            background-color: #333; 
            z-index: 150;
        }
        #editor-controls {
            position: absolute; top: 10px; right: 10px; 
            padding: 15px; background: rgba(0, 0, 0, 0.8); 
            color: white; border-radius: 10px; z-index: 160;
            width: 300px;
        }
        
        /* --- UI –§–ï–†–ú–´ --- */
        #farm-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none;
            background-color: #333; 
            z-index: 150;
        }
        #farm-hud {
            position: absolute; top: 10px; right: 10px; 
            padding: 15px; background: rgba(0, 0, 0, 0.8); 
            color: white; border-radius: 10px; z-index: 160;
            width: 250px;
        }
        #money-display {
            font-size: 24px; font-weight: bold; margin-bottom: 10px; color: #4CAF50;
        }
        #inventory-display {
            font-size: 16px; margin-bottom: 15px; border-top: 1px solid #444; padding-top: 5px;
        }
        #shop-button {
            padding: 10px; background: #FF9800; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;
            font-weight: bold;
        }
        #shop-modal {
            display: none; 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9); padding: 20px; border-radius: 10px;
            width: 350px; max-height: 80vh; overflow-y: auto; z-index: 200;
            border: 3px solid #FFD700;
        }
        .item-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; border-bottom: 1px dashed #444;
        }
        .buy-button {
            padding: 5px 10px; background: #2196F3; color: white; border: none; border-radius: 3px; cursor: pointer;
        }
        #interaction-message {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8); color: white; padding: 10px 20px;
            border-radius: 5px; z-index: 160; font-size: 18px; display: none;
        }

        /* --- UI –ë–õ–û–ì–ï–†–ê (–ù–û–í–´–ô) --- */
        #blogger-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none;
            background-color: #333; 
            z-index: 150;
        }
        #blogger-hud {
            position: absolute; top: 10px; right: 10px; 
            padding: 15px; background: rgba(0, 0, 0, 0.8); 
            color: white; border-radius: 10px; z-index: 160;
            width: 250px;
        }
        #stats-display {
            font-size: 20px; margin-bottom: 10px; color: #FFD700;
        }
        #shoot-video-button {
            padding: 15px; background: #FF0000; color: white; border: none; border-radius: 5px; 
            cursor: pointer; width: 100%; font-weight: bold; margin-bottom: 15px;
            font-size: 20px;
        }
        #upgrade-section {
            border-top: 1px solid #444; padding-top: 10px;
        }
        .blogger-upgrade-button {
            display: block; width: 100%; padding: 10px; margin-top: 8px;
            background: #008CBA; color: white; border: none; border-radius: 5px; cursor: pointer;
            transition: background 0.1s;
        }

    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>
</head>
<body>

<div id="menu-container">
    <div id="menu-box">
        <h1>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –∏–≥—Ä—ã</h1>
        <button class="mode-button" id="start-parkour">–ü–∞—Ä–∫—É—Ä üèÉ‚Äç‚ôÇÔ∏è (–ì—Ä–∞—Ñ–∏–∫–∞ 2.0)</button>
        <button class="mode-button" id="start-clicker">–ö–ª–∏–∫–µ—Ä üí∞</button>
        <button class="mode-button" id="start-editor">–†–µ–¥–∞–∫—Ç–æ—Ä –ü–µ—Ä—Å–æ–Ω–∞–∂–∞ üé®</button>
        <button class="mode-button" id="start-farm">–§–µ—Ä–º–∞ üåæ (–ì—Ä–∞—Ñ–∏–∫–∞ 2.0)</button>
        <button class="mode-button" id="start-blogger">–ë–ª–æ–≥–µ—Ä üìπ (–ì—Ä–∞—Ñ–∏–∫–∞ 2.0)</button>
    </div>
</div>

<div id="game-container" style="display:none;"> 
    <button id="admin-fly-button">ADMIN: –ü–æ–ª–µ—Ç</button> 
    <div id="crosshair"></div>
    <div id="trophy-message">üèÜ –ü–û–ó–î–†–ê–í–õ–Ø–ï–ú! –†–ï–ñ–ò–ú –ü–û–õ–ï–¢–ê –ê–ö–¢–ò–í–ò–†–û–í–ê–ù! üöÄ</div>
    <div id="ui" style="display:none;"> 
        <h1 id="welcome-message"></h1>
        <p id="info-message"></p>
        <p>–ö–õ–ò–ö–ù–ò –°–Æ–î–ê –ß–¢–û–ë–´ –ò–ì–†–ê–¢–¨</p>
        <hr>
        <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: WASD + –ü–†–û–ë–ï–õ (–ø—Ä—ã–∂–æ–∫/–≤–≤–µ—Ä—Ö)</p>
    </div>
</div>

<div id="clicker-ui">
    <div class="back-to-menu">‚Üê –ú–ï–ù–Æ</div>
    <div id="click-count">–ö–ª–∏–∫–∏: 0</div>
    <button id="click-button">–ö–õ–ò–ö</button>
    <button class="upgrade-button" id="upgrade-50" data-cost="50">–£–õ–£–ß–®–ï–ù–ò–ï (–¶–µ–Ω–∞: 50)</button>
    <button class="upgrade-button" id="upgrade-90" data-cost="90" disabled>–ú–ï–ì–ê –£–õ–£–ß–®–ï–ù–ò–ï (–¶–µ–Ω–∞: 90)</button>
    <button class="upgrade-button" id="upgrade-400" data-cost="400" disabled>–°–£–ü–ï–† –£–õ–£–ß–®–ï–ù–ò–ï (–¶–µ–Ω–∞: 400)</button>
</div>

<div id="farm-ui">
    <div class="back-to-menu" id="back-to-menu-farm">‚Üê –ú–ï–ù–Æ</div>
    <div id="farm-hud">
        <div id="money-display">–î–µ–Ω—å–≥–∏: $20</div>
        <div id="inventory-display">
            –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å:
            <span id="inv-carrot">–ú–æ—Ä–∫–æ–≤—å: 0</span>, 
            <span id="inv-watermelon">–ê—Ä–±—É–∑: 0</span>
        </div>
        <button id="shop-button">–û—Ç–∫—Ä—ã—Ç—å –ú–∞–≥–∞–∑–∏–Ω/–ü—Ä–æ–¥–∞–∂–∞ üõí</button>
        <p style="margin-top: 15px; font-size: 14px;">–ö–ª–∏–∫–Ω–∏ –Ω–∞ –≥—Ä—è–¥–∫—É, —á—Ç–æ–±—ã –ø–æ—Å–∞–¥–∏—Ç—å —Å–µ–º–µ–Ω–∞ –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è.</p>
    </div>
    
    <div id="interaction-message"></div>

    <div id="shop-modal">
        <h3>üõí –ú–∞–≥–∞–∑–∏–Ω</h3>
        <div id="shop-items"></div>
        <h3 style="margin-top: 20px;">üí∞ –ü—Ä–æ–¥–∞–∂–∞</h3>
        <div id="sell-items"></div>
        <button onclick="document.getElementById('shop-modal').style.display='none'" style="margin-top: 20px; padding: 10px; width: 100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<div id="editor-ui" >
    <div class="back-to-menu" id="back-to-menu-editor">‚Üê –ú–ï–ù–Æ</div>
    <div id="editor-controls">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ü–µ—Ä—Å–æ–Ω–∞–∂–∞</h2>
        <div class="control-group">
            <label for="head-color">–¶–≤–µ—Ç –ì–æ–ª–æ–≤—ã:</label>
            <input type="color" id="head-color" value="#FFE0B2">
        </div>
        <div class="control-group">
            <label for="shirt-color">–¶–≤–µ—Ç –†—É–±–∞—à–∫–∏ (–¢—É–ª–æ–≤–∏—â–µ):</label>
            <input type="color" id="shirt-color" value="#007BFF">
        </div>
        <div class="control-group">
            <label for="pants-color">–¶–≤–µ—Ç –®—Ç–∞–Ω–æ–≤ (–ù–æ–≥–∏):</label>
            <input type="color" id="pants-color" value="#333333">
        </div>
        <div class="control-group">
            <label>–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã:</label>
            <input type="checkbox" id="hat-toggle" checked>
            <label for="hat-toggle">–ö–∞–ø–µ–ª—é—Ö (–®–ª—è–ø–∞)</label>
        </div>
        <div class="control-group">
            <label for="face-texture-url">URL –¥–ª—è –õ–∏—Ü–∞ (–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ):</label>
            <input type="text" id="face-texture-url" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ 1:1" value="">
            <small>–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ üñºÔ∏è</small>
        </div>
    </div>
</div>

<div id="blogger-ui">
    <div class="back-to-menu" id="back-to-menu-blogger">‚Üê –ú–ï–ù–Æ</div>
    <div id="blogger-hud">
        <h2>–°—Ç—É–¥–∏—è –ë–ª–æ–≥–µ—Ä–∞</h2>
        <div id="stats-display">
            <p>üí∞ –î–µ–Ω—å–≥–∏: $0</p>
            <p>üëÄ –ü—Ä–æ—Å–º–æ—Ç—Ä—ã: 0</p>
            <p>‚úÖ –ü–æ–¥–ø–∏—Å—á–∏–∫–∏: 0</p>
            <p>‚è±Ô∏è –ü—Ä–æ—Å–º–æ—Ç—Ä—ã/—Å–µ–∫: 0</p>
        </div>
        
        <button id="shoot-video-button">–°–Ω—è—Ç—å –í–∏–¥–µ–æ (x1)</button>
        
        <div id="upgrade-section">
            <h3>–£–ª—É—á—à–µ–Ω–∏—è</h3>
            </div>
    </div>
</div>

<script>
    if (typeof THREE === 'undefined') { alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Three.js!"); }

    // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
    let camera, scene, renderer, controls;
    let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
    let canJump = false;
    let velocity = new THREE.Vector3();
    let direction = new THREE.Vector3();
    let prevTime = performance.now();
    let isFlying = false; 
    let flyUp = false;
    let flyDown = false;
    let trophy; 
    const FLY_SPEED = 200;
    const platforms = []; 
    let rotatingBlock1, rotatingBlock2; 
    let movingBlock; 
    let animateId = null; 
    let currentMode = '';

    // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ö–õ–ò–ö–ï–†–ê ---
    let clicks = 0;
    let clickValue = 1;
    let upgrade50Purchased = false;
    let upgrade90Purchased = false;
    let upgrade400Purchased = false; 

    // --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –†–ï–î–ê–ö–¢–û–†–ê ---
    let editorScene, editorCamera, editorRenderer;
    let characterGroup;
    let charParts = {}; 
    const textureLoader = new THREE.TextureLoader();
    let editorAnimateId = null; 
    
    // --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –§–ï–†–ú–´ ---
    let farmScene, farmCamera, farmRenderer, farmControls;
    let money = 20; 
    const farmInventory = {
        carrot: 0,
        watermelon: 0,
    };
    const shopItems = {
        carrot: { cost: 10, sell: 100, growthTime: 10, name: "–ú–æ—Ä–∫–æ–≤—å", icon: "ü•ï" },
        watermelon: { cost: 100, sell: 2000, growthTime: 20, name: "–ê—Ä–±—É–∑", icon: "üçâ" },
    };
    const plots = [];
    let selectedItemToPlant = 'carrot';
    const INTERACTION_RANGE = 5;
    let farmAnimateId = null; 

    // --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ë–õ–û–ì–ï–†–ê (–ù–û–í–´–ï) ---
    let bloggerScene, bloggerCamera, bloggerRenderer, bloggerControls;
    let bloggerAnimateId = null;
    let moneyBlogger = 0;
    let views = 0;
    let subscribers = 0;
    let viewsPerClick = 1;
    let autoViewsPerSecond = 0;
    let lastAutoViewTime = performance.now();
    let bloggerUpgrades = {
        mic: { cost: 50, effect: 1, type: 'click', name: "–ù–æ–≤—ã–π –ú–∏–∫—Ä–æ—Ñ–æ–Ω üé§", purchased: false },
        lighting: { cost: 200, effect: 5, type: 'click', name: "–ü—Ä–æ—Ñ. –°–≤–µ—Ç üí°", purchased: false },
        editor: { cost: 500, effect: 1, type: 'auto', name: "–ù–∞–Ω—è—Ç—å –ú–æ–Ω—Ç–∞–∂—ë—Ä–∞ üßë‚Äçüíª", purchased: false },
        camera: { cost: 1000, effect: 10, type: 'click', name: "4K –ö–∞–º–µ—Ä–∞ üé•", purchased: false },
        marketing: { cost: 2000, effect: 5, type: 'auto', name: "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥-–±–æ—Ç ü§ñ", purchased: false },
    };


    // --- –¢–ï–ö–°–¢–£–†–´ ---
    const TEXTURES = {
        grass: 'https://threejs.org/examples/textures/terrain/grasslight-big.jpg',
        stone: 'https://threejs.org/examples/textures/terrain/rock.jpg',
        dirt: 'https://threejs.org/examples/textures/terrain/dirt.jpg',
        lava: 'https://threejs.org/examples/textures/water/Water_1_M_Normal.jpg', 
    };

    // --- –õ–û–ì–ò–ö–ê –ú–ï–ù–Æ ---
    document.getElementById('start-parkour').addEventListener('click', startParkourMode);
    document.getElementById('start-clicker').addEventListener('click', startClickerMode);
    document.getElementById('start-editor').addEventListener('click', startEditorMode);
    document.getElementById('start-farm').addEventListener('click', startFarmMode);
    document.getElementById('start-blogger').addEventListener('click', startBloggerMode); // –ù–û–í–´–ô –†–ï–ñ–ò–ú
    
    document.querySelectorAll('.back-to-menu').forEach(button => {
        button.addEventListener('click', showMainMenu);
    });

    function showMainMenu() {
        document.getElementById('menu-container').style.display = 'flex';
        currentMode = '';
        
        // 1. –°–±—Ä–æ—Å –∏ —Å–∫—Ä—ã—Ç–∏–µ –í–°–ï–• –∏–≥—Ä–æ–≤—ã—Ö UI
        document.getElementById('clicker-ui').style.display = 'none';
        document.getElementById('editor-ui').style.display = 'none';
        document.getElementById('farm-ui').style.display = 'none';
        document.getElementById('game-container').style.display = 'none';
        document.getElementById('blogger-ui').style.display = 'none'; // –ù–û–í–´–ô

        
        // 2. –û—Ç–º–µ–Ω–∞ —Ü–∏–∫–ª–æ–≤ –∞–Ω–∏–º–∞—Ü–∏–∏
        if (animateId) cancelAnimationFrame(animateId);
        if (editorAnimateId) cancelAnimationFrame(editorAnimateId);
        if (farmAnimateId) cancelAnimationFrame(farmAnimateId);
        if (bloggerAnimateId) cancelAnimationFrame(bloggerAnimateId); // –ù–û–í–´–ô
        animateId = editorAnimateId = farmAnimateId = bloggerAnimateId = null;

        // 3. –£–¥–∞–ª–µ–Ω–∏–µ Canvas (–æ—á–∏—Å—Ç–∫–∞ 3D-—Å—Ü–µ–Ω)
        [renderer, editorRenderer, farmRenderer, bloggerRenderer].forEach(r => { // –ù–û–í–´–ô
            if (r && r.domElement) {
                if (r.domElement.parentNode) {
                     r.domElement.parentNode.removeChild(r.domElement);
                }
            }
        });
        // –°–±—Ä–æ—Å —Å—Å—ã–ª–æ–∫
        renderer = editorRenderer = farmRenderer = bloggerRenderer = null; // –ù–û–í–´–ô
        scene = editorScene = farmScene = bloggerScene = null; // –ù–û–í–´–ô
        controls = farmControls = bloggerControls = null; // –ù–û–í–´–ô
        
        // 4. –°–±—Ä–æ—Å –æ–±—â–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        document.removeEventListener('keydown', onFarmKeyDown);
        document.removeEventListener('keyup', onFarmKeyUp);
        document.removeEventListener('keydown', onKeyDown);
        document.removeEventListener('keyup', onKeyUp);
        document.removeEventListener('keydown', onBloggerKeyDown); // –ù–û–í–´–ô
        document.removeEventListener('keyup', onBloggerKeyUp); // –ù–û–í–´–ô
        window.removeEventListener('resize', onWindowResize);
    }

    function performRegistration() {
        playerName = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:", "–ò–≥—Ä–æ–∫ Roblox");
        if (playerName === null || playerName.trim() === '') { playerName = '–ò–≥—Ä–æ–∫'; }
        playerBirthYear = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≥–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è:", "2000");
        
        document.getElementById('welcome-message').innerText = `${playerName.toUpperCase()}, –î–û–ë–†–û –ü–û–ñ–ê–õ–û–í–ê–¢–¨!`;
        document.getElementById('info-message').innerText = `–ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è: ${playerBirthYear}.`;
    }

    // --- 1. –†–ï–ñ–ò–ú –ü–ê–†–ö–£–†–ê ---
    function createTexturedBlock(x, y, z, w, h, d, material) { 
        const geo = new THREE.BoxGeometry(w, h, d);
        const mesh = new THREE.Mesh(geo, material);
        mesh.position.set(x, y, z);
        mesh.receiveShadow = true; 
        mesh.castShadow = true;   
        scene.add(mesh);
        platforms.push(mesh);
        return mesh;
    }
    
    function createTrophy(x, y, z) { 
        const baseMat = new THREE.MeshStandardMaterial({ color: 0xFFD700, metalness: 0.9, roughness: 0.1 });
        const base = new THREE.Mesh(new THREE.BoxGeometry(3, 1, 3), baseMat);
        const cup = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 0.5, 4, 16), baseMat);
        base.position.y = 0; 
        cup.position.y = 2.5; 
        const group = new THREE.Group();
        group.add(base);
        group.add(cup);
        group.position.set(x, y, z); 
        scene.add(group);
        return group;
    }

    function createLevel() { 
        platforms.length = 0; 

        const basicMat = new THREE.MeshStandardMaterial({ color: 0xAAAAAA });
        const stoneMat = new THREE.MeshStandardMaterial({ map: textureLoader.load(TEXTURES.stone) });

        const groundTexture = textureLoader.load(TEXTURES.stone);
        groundTexture.wrapS = groundTexture.wrapT = THREE.RepeatWrapping;
        groundTexture.repeat.set(8, 8);
        const groundMat = new THREE.MeshStandardMaterial({ map: groundTexture, color: 0x888888 });

        const startBlock = createTexturedBlock(0, -2, 0, 20, 4, 20, groundMat);
        startBlock.receiveShadow = true;

        createTexturedBlock(0, -2, 25, 6, 2, 6, basicMat); 
        rotatingBlock1 = createTexturedBlock(0, 0, 40, 15, 2, 8, stoneMat); 
        createTexturedBlock(15, 6, 55, 6, 2, 6, basicMat); 
        
        movingBlock = createTexturedBlock(15, 10, 70, 4, 2, 4, stoneMat); 
        movingBlock.userData.direction = 1; 
        movingBlock.userData.startY = 10;
        
        createTexturedBlock(0, 18, 85, 2, 2, 2, basicMat); 
        createTexturedBlock(0, 22, 95, 2, 2, 2, basicMat); 
        
        rotatingBlock2 = createTexturedBlock(0, 26, 110, 10, 2, 10, stoneMat); 

        createTexturedBlock(15, 30, 130, 4, 2, 4, basicMat);
        
        const finishMat = new THREE.MeshStandardMaterial({ color: 0xFFFFFF, roughness: 0.1 });
        createTexturedBlock(0, 32, 150, 30, 2, 30, finishMat); 
        
        const TROPHY_POSITION = new THREE.Vector3(0, 34, 150);
        trophy = createTrophy(TROPHY_POSITION.x, TROPHY_POSITION.y, TROPHY_POSITION.z);
        
        const lavaGeo = new THREE.PlaneGeometry(2000, 2000);
        const lavaMat = new THREE.MeshBasicMaterial({ color: 0xFF2200 }); 
        const lava = new THREE.Mesh(lavaGeo, lavaMat);
        lava.rotation.x = -Math.PI / 2;
        lava.position.y = -30;
        scene.add(lava);
    }
    
    function initParkour() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.Fog(0x87CEEB, 0, 800);

        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);
        camera.position.y = 10;

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(20, 50, 20); 
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.width = 1024;
        directionalLight.shadow.mapSize.height = 1024;
        directionalLight.shadow.camera.near = 0.5;
        directionalLight.shadow.camera.far = 100;
        directionalLight.shadow.camera.left = -50;
        directionalLight.shadow.camera.right = 50;
        directionalLight.shadow.camera.top = 50;
        directionalLight.shadow.camera.bottom = -50;
        scene.add(directionalLight);

        const ambientLight = new THREE.AmbientLight(0x404040, 1);
        scene.add(ambientLight);
        
        controls = new THREE.PointerLockControls(camera, document.body);
        
        document.getElementById('ui').addEventListener('click', function() { controls.lock(); });
        
        document.removeEventListener('keydown', onKeyDown);
        document.removeEventListener('keyup', onKeyUp);
        document.addEventListener('keydown', onKeyDown);
        document.addEventListener('keyup', onKeyUp);

        createLevel(); 

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.getElementById('game-container').appendChild(renderer.domElement);
        
        isFlying = false;
        camera.position.set(0, 10, 0);

        document.getElementById('admin-fly-button').addEventListener('click', toggleAdminFly);
        window.addEventListener('resize', onWindowResize);
    }
    
    function startParkourMode() {
        document.getElementById('menu-container').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        document.getElementById('ui').style.display = 'flex';
        currentMode = 'parkour';

        if (!renderer) {
            initParkour();
        }
        animateId = requestAnimationFrame(animate);
    }

    // --- 2. –†–ï–ñ–ò–ú –ö–õ–ò–ö–ï–†–ê ---
    function startClickerMode() {
        showMainMenu(); 
        document.getElementById('menu-container').style.display = 'none';
        document.getElementById('clicker-ui').style.display = 'flex';
        currentMode = 'clicker';
        
        clicks = 0;
        clickValue = 1;
        upgrade50Purchased = false;
        upgrade90Purchased = false;
        upgrade400Purchased = false; 

        updateClickerUI();
    }
    
    // --- 3. –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–û–†–ê ---
    // ... (initEditorScene, createCharacterPreview, setupEditorControls, animateEditor - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
    function initEditorScene() {
        editorScene = new THREE.Scene();
        editorScene.background = new THREE.Color(0x333333);

        editorCamera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 100);
        editorCamera.position.set(0, 1.5, 5);
        editorScene.add(editorCamera);

        const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
        editorScene.add(light);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(1, 2, 1);
        editorScene.add(directionalLight);

        editorRenderer = new THREE.WebGLRenderer({ antialias: true });
        editorRenderer.setPixelRatio(window.devicePixelRatio);
        editorRenderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('editor-ui').appendChild(editorRenderer.domElement);

        createCharacterPreview();
    }
    function createCharacterPreview() {
        if (characterGroup) editorScene.remove(characterGroup);

        characterGroup = new THREE.Group();

        const headGeo = new THREE.BoxGeometry(1, 1, 1);
        charParts.headMat = new THREE.MeshLambertMaterial({ color: document.getElementById('head-color').value });
        charParts.head = new THREE.Mesh(headGeo, charParts.headMat);
        charParts.head.position.y = 1.75; 
        characterGroup.add(charParts.head);

        const torsoGeo = new THREE.BoxGeometry(1, 1.5, 0.5);
        charParts.torsoMat = new THREE.MeshLambertMaterial({ color: document.getElementById('shirt-color').value });
        charParts.torso = new THREE.Mesh(torsoGeo, charParts.torsoMat);
        charParts.torso.position.y = 0.75;
        characterGroup.add(charParts.torso);

        const legGeo = new THREE.BoxGeometry(0.5, 1.5, 0.5);
        charParts.legMat = new THREE.MeshLambertMaterial({ color: document.getElementById('pants-color').value });
        
        charParts.legL = new THREE.Mesh(legGeo, charParts.legMat);
        charParts.legL.position.set(-0.25, -0.75, 0); 
        characterGroup.add(charParts.legL);
        
        charParts.legR = new THREE.Mesh(legGeo, charParts.legMat);
        charParts.legR.position.set(0.25, -0.75, 0);
        characterGroup.add(charParts.legR);
        
        const hatGeo = new THREE.ConeGeometry(0.6, 0.5, 16);
        charParts.hatMat = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
        charParts.hat = new THREE.Mesh(hatGeo, charParts.hatMat);
        charParts.hat.position.y = 2.4; 
        charParts.hat.visible = document.getElementById('hat-toggle').checked;
        characterGroup.add(charParts.hat);

        editorScene.add(characterGroup);
        updateCharacterPreview();
    }
    function setupEditorControls() {
        document.getElementById('head-color').addEventListener('input', updateCharacterPreview);
        document.getElementById('shirt-color').addEventListener('input', updateCharacterPreview);
        document.getElementById('pants-color').addEventListener('input', updateCharacterPreview);
        document.getElementById('hat-toggle').addEventListener('change', updateCharacterPreview);
        document.getElementById('face-texture-url').addEventListener('change', updateCharacterPreview);
    }
    function animateEditor() {
        if (!editorRenderer) return;
        editorAnimateId = requestAnimationFrame(animateEditor);
        
        if (characterGroup) {
            characterGroup.rotation.y += 0.01;
        }

        editorRenderer.render(editorScene, editorCamera);
    }
    
    function startEditorMode() {
        showMainMenu(); 
        document.getElementById('menu-container').style.display = 'none';
        document.getElementById('editor-ui').style.display = 'block';
        currentMode = 'editor';

        if (!editorRenderer) {
            initEditorScene();
            setupEditorControls();
        } else {
            updateCharacterPreview();
        }
        editorAnimateId = requestAnimationFrame(animateEditor);
        window.addEventListener('resize', onWindowResize);
    }

    // --- 4. –†–ï–ñ–ò–ú –§–ï–†–ú–´ ---
    function startFarmMode() {
        document.getElementById('menu-container').style.display = 'none';
        document.getElementById('farm-ui').style.display = 'block';
        currentMode = 'farm';
        
        if (!farmRenderer) {
            initFarmScene();
            setupFarmControls();
        }
        updateFarmHUD();
        farmAnimateId = requestAnimationFrame(farmAnimate);
        window.addEventListener('resize', onWindowResize);
    }

    function initFarmScene() {
        farmScene = new THREE.Scene();
        farmScene.background = new THREE.Color(0x87CEEB);
        farmScene.fog = new THREE.Fog(0x87CEEB, 0, 50);

        farmCamera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        farmCamera.position.set(0, 2, 5);

        const sunLight = new THREE.DirectionalLight(0xffffff, 1.5);
        sunLight.position.set(10, 15, 10);
        sunLight.castShadow = true;
        sunLight.shadow.mapSize.width = 1024;
        sunLight.shadow.mapSize.height = 1024;
        sunLight.shadow.camera.near = 0.5;
        sunLight.shadow.camera.far = 50;
        sunLight.shadow.camera.left = -15;
        sunLight.shadow.camera.right = 15;
        sunLight.shadow.camera.top = 15;
        sunLight.shadow.camera.bottom = -15;
        farmScene.add(sunLight);
        
        const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
        farmScene.add(ambientLight);

        const grassTexture = textureLoader.load(TEXTURES.grass);
        grassTexture.wrapS = grassTexture.wrapT = THREE.RepeatWrapping;
        grassTexture.repeat.set(10, 10);
        const groundGeo = new THREE.PlaneGeometry(100, 100);
        const groundMat = new THREE.MeshStandardMaterial({ map: grassTexture });
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        farmScene.add(ground);

        createFarmPlots(); 
        
        farmRenderer = new THREE.WebGLRenderer({ antialias: true });
        farmRenderer.setPixelRatio(window.devicePixelRatio);
        farmRenderer.setSize(window.innerWidth, window.innerHeight);
        farmRenderer.shadowMap.enabled = true;
        document.getElementById('farm-ui').appendChild(farmRenderer.domElement);
        
        farmControls = new THREE.PointerLockControls(farmCamera, farmRenderer.domElement);
        farmRenderer.domElement.addEventListener('click', function() { farmControls.lock(); });
        farmControls.addEventListener('lock', function() {
            document.getElementById('interaction-message').style.display = 'block';
        });
        farmControls.addEventListener('unlock', function() {
            document.getElementById('interaction-message').style.display = 'none';
        });
    }

    // --- 5. –†–ï–ñ–ò–ú –ë–õ–û–ì–ï–†–ê (–ù–û–í–´–ô) ---

    function createStudioScene() {
        bloggerScene = new THREE.Scene();
        bloggerScene.background = new THREE.Color(0xAAAAAA); 
        bloggerScene.fog = new THREE.Fog(0xAAAAAA, 10, 50);

        bloggerCamera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
        bloggerCamera.position.set(0, 1.6, 5); // Start at human height (1.6m)

        // Lights
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.8);
        bloggerScene.add(hemiLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(5, 5, 5);
        dirLight.castShadow = true;
        bloggerScene.add(dirLight);

        // Ground (Floor)
        const groundGeo = new THREE.PlaneGeometry(50, 50);
        const groundMat = new THREE.MeshStandardMaterial({ color: 0x444444 });
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        bloggerScene.add(ground);
        
        // Walls (Simple studio box)
        const wallMat = new THREE.MeshStandardMaterial({ color: 0xFFFFFF });
        
        // Back Wall
        const wallBack = new THREE.Mesh(new THREE.PlaneGeometry(10, 5), wallMat);
        wallBack.position.set(0, 2.5, -5);
        bloggerScene.add(wallBack);
        
        // Desk (for PC)
        const deskGeo = new THREE.BoxGeometry(2, 0.8, 1);
        const deskMat = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
        const desk = new THREE.Mesh(deskGeo, deskMat);
        desk.position.set(0, 0.4, -4.5);
        desk.receiveShadow = true;
        bloggerScene.add(desk);

        // Computer (PC) - Interaction point
        const pcGeo = new THREE.BoxGeometry(0.8, 0.6, 0.1);
        const pcMat = new THREE.MeshStandardMaterial({ color: 0x000000 });
        const pc = new THREE.Mesh(pcGeo, pcMat);
        pc.position.set(0, 0.9, -4.5);
        pc.userData.isInteractable = true;
        pc.userData.action = 'shootVideo';
        bloggerScene.add(pc);


        bloggerRenderer = new THREE.WebGLRenderer({ antialias: true });
        bloggerRenderer.setPixelRatio(window.devicePixelRatio);
        bloggerRenderer.setSize(window.innerWidth, window.innerHeight);
        bloggerRenderer.shadowMap.enabled = true;
        document.getElementById('blogger-ui').appendChild(bloggerRenderer.domElement);
        
        bloggerControls = new THREE.PointerLockControls(bloggerCamera, bloggerRenderer.domElement);
        // Add click listener only to canvas
        bloggerRenderer.domElement.addEventListener('click', function() { if (currentMode === 'blogger') bloggerControls.lock(); });
        bloggerControls.addEventListener('lock', function() {
            document.getElementById('interaction-message').style.display = 'block';
            document.getElementById('interaction-message').innerText = "–ù–∞–∂–º–∏—Ç–µ 'E' (–∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –∫–Ω–æ–ø–∫—É) –¥–ª—è —Å—ä–µ–º–∫–∏. WASD –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è.";
        });
        bloggerControls.addEventListener('unlock', function() {
            document.getElementById('interaction-message').style.display = 'none';
        });
    }
    
    function startBloggerMode() {
        showMainMenu(); 
        document.getElementById('menu-container').style.display = 'none';
        document.getElementById('blogger-ui').style.display = 'block';
        
        if (!bloggerRenderer) {
            createStudioScene();
            setupBloggerControls();
        }
        
        currentMode = 'blogger'; 
        
        // Reset stats
        moneyBlogger = 0;
        views = 0;
        subscribers = 0;
        viewsPerClick = 1;
        autoViewsPerSecond = 0;
        // Reset upgrades
        Object.keys(bloggerUpgrades).forEach(key => bloggerUpgrades[key].purchased = false);
        
        updateBloggerLogic(); 
        bloggerAnimateId = requestAnimationFrame(bloggerAnimate);
        window.addEventListener('resize', onWindowResize);
    }

    function updateBloggerHUD() {
        document.getElementById('stats-display').innerHTML = `
            <p>üí∞ –î–µ–Ω—å–≥–∏: $${moneyBlogger.toFixed(2)}</p>
            <p>üëÄ –ü—Ä–æ—Å–º–æ—Ç—Ä—ã: ${Math.floor(views)}</p>
            <p>‚úÖ –ü–æ–¥–ø–∏—Å—á–∏–∫–∏: ${subscribers}</p>
            <p>‚è±Ô∏è –ü—Ä–æ—Å–º–æ—Ç—Ä—ã/—Å–µ–∫: ${autoViewsPerSecond}</p>
        `;
        document.getElementById('shoot-video-button').innerText = `–°–Ω—è—Ç—å –í–∏–¥–µ–æ (x${viewsPerClick} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤)`;
        
        const upgradeSection = document.getElementById('upgrade-section');
        upgradeSection.innerHTML = '<h3>–£–ª—É—á—à–µ–Ω–∏—è</h3>';
        
        Object.keys(bloggerUpgrades).forEach(key => {
            const upgrade = bloggerUpgrades[key];
            if (upgrade.purchased) return;
            
            const btn = document.createElement('button');
            btn.className = 'blogger-upgrade-button';
            btn.id = `upgrade-${key}`;
            btn.innerText = `${upgrade.name} - $${upgrade.cost} (x${upgrade.effect} ${upgrade.type === 'click' ? '–∫–ª–∏–∫' : '—Å–µ–∫'})`;
            btn.onclick = () => buyUpgrade(key);
            btn.disabled = moneyBlogger < upgrade.cost;
            
            upgradeSection.appendChild(btn);
        });
    }

    window.shootVideo = function() {
        if (currentMode !== 'blogger') return;

        const baseViews = viewsPerClick;
        const newViews = baseViews * (1 + subscribers / 100); // Subscribers boost views
        views += newViews;
        
        // 100 views -> 1 subscriber chance
        subscribers += Math.floor(newViews / 100);
        
        // Convert views to money
        const moneyEarned = newViews / 100; // 100 views = $1
        moneyBlogger += moneyEarned;
        
        showMessage(`+${newViews.toFixed(1)} –ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤, +$${moneyEarned.toFixed(2)}!`, 1000);
        updateBloggerHUD();
    }
    
    window.buyUpgrade = function(key) {
        if (currentMode !== 'blogger') return;
        
        const upgrade = bloggerUpgrades[key];
        if (moneyBlogger >= upgrade.cost && !upgrade.purchased) {
            moneyBlogger -= upgrade.cost;
            upgrade.purchased = true;
            
            if (upgrade.type === 'click') {
                viewsPerClick += upgrade.effect;
                showMessage(`${upgrade.name} –∫—É–ø–ª–µ–Ω–æ! –ü—Ä–æ—Å–º–æ—Ç—Ä—ã –∑–∞ –∫–ª–∏–∫: +${upgrade.effect}!`, 2000);
            } else if (upgrade.type === 'auto') {
                autoViewsPerSecond += upgrade.effect;
                showMessage(`${upgrade.name} –∫—É–ø–ª–µ–Ω–æ! –ü—Ä–æ—Å–º–æ—Ç—Ä—ã/—Å–µ–∫: +${upgrade.effect}!`, 2000);
            }
            
            updateBloggerHUD();
        }
    }
    
    function updateBloggerLogic() {
        document.getElementById('shoot-video-button').addEventListener('click', shootVideo);
        updateBloggerHUD();
    }
    
    function setupBloggerControls() {
        document.removeEventListener('keydown', onBloggerKeyDown);
        document.removeEventListener('keyup', onBloggerKeyUp);
        document.addEventListener('keydown', onBloggerKeyDown);
        document.addEventListener('keyup', onBloggerKeyUp);
    }
    
    function onBloggerKeyDown(event) {
        if (!bloggerControls || bloggerControls.isLocked !== true) return;
        switch (event.code) {
            case 'ArrowUp': case 'KeyW': moveForward = true; break;
            case 'ArrowLeft': case 'KeyA': moveLeft = true; break;
            case 'ArrowDown': case 'KeyS': moveBackward = true; break;
            case 'ArrowRight': case 'KeyD': moveRight = true; break;
            case 'KeyE': shootVideo(); break; // Interaction key
        }
    }
    
    function onBloggerKeyUp(event) {
        if (!bloggerControls || bloggerControls.isLocked !== true) return;
        switch (event.code) {
            case 'ArrowUp': case 'KeyW': moveForward = false; break;
            case 'ArrowLeft': case 'KeyA': moveLeft = false; break;
            case 'ArrowDown': case 'KeyS': moveBackward = false; break;
            case 'ArrowRight': case 'KeyD': moveRight = false; break;
        }
    }

    // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò –ê–ù–ò–ú–ê–¶–ò–Ø ---
    
    // ... (updateClickerUI, updateCharacterPreview, showMessage, setupFarmControls, onFarmKeyDown, onFarmKeyUp, handlePlotInteraction, updateGrowth, toggleAdminFly, checkTrophyCollision, onKeyDown, onKeyUp - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...

    function updateClickerUI() {
        document.getElementById('click-count').innerText = `–ö–ª–∏–∫–∏: ${clicks} (x${clickValue})`;
        
        const upgrade50Btn = document.getElementById('upgrade-50');
        const upgrade90Btn = document.getElementById('upgrade-90');
        const upgrade400Btn = document.getElementById('upgrade-400'); 

        if (!upgrade50Purchased) {
            upgrade50Btn.disabled = clicks < 50;
            upgrade50Btn.innerText = `–£–õ–£–ß–®–ï–ù–ò–ï (–¶–µ–Ω–∞: 50). –ö–ª–∏–∫ x2`;
        } else {
            upgrade50Btn.disabled = true;
            upgrade50Btn.innerText = `–£–õ–£–ß–®–ï–ù–ò–ï (–ö–£–ü–õ–ï–ù–û)`;
        }

        if (!upgrade90Purchased) {
            upgrade90Btn.disabled = clicks < 90 || !upgrade50Purchased; 
            upgrade90Btn.innerText = `–ú–ï–ì–ê –£–õ–£–ß–®–ï–ù–ò–ï (–¶–µ–Ω–∞: 90). –ö–ª–∏–∫ x5`;
        } else {
            upgrade90Btn.disabled = true;
            upgrade90Btn.innerText = `–ú–ï–ì–ê –£–õ–£–ß–®–ï–ù–ò–ï (–ö–£–ü–õ–ï–ù–û)`;
        }

        if (!upgrade400Purchased) {
            upgrade400Btn.disabled = clicks < 400 || !upgrade90Purchased;
            upgrade400Btn.innerText = `–°–£–ü–ï–† –£–õ–£–ß–®–ï–ù–ò–ï (–¶–µ–Ω–∞: 400). –ö–ª–∏–∫ x10`;
        } else {
            upgrade400Btn.disabled = true;
            upgrade400Btn.innerText = `–°–£–ü–ï–† –£–õ–£–ß–®–ï–ù–ò–ï (–ö–£–ü–õ–ï–ù–û)`;
        }
    }

    document.getElementById('click-button').addEventListener('click', () => { clicks += clickValue; updateClickerUI(); });
    document.getElementById('upgrade-50').addEventListener('click', () => { if (clicks >= 50 && !upgrade50Purchased) { clicks -= 50; clickValue = 2; upgrade50Purchased = true; updateClickerUI(); } });
    document.getElementById('upgrade-90').addEventListener('click', () => { if (clicks >= 90 && !upgrade90Purchased && upgrade50Purchased) { clicks -= 90; clickValue = 5; upgrade90Purchased = true; updateClickerUI(); } });
    document.getElementById('upgrade-400').addEventListener('click', () => { if (clicks >= 400 && !upgrade400Purchased && upgrade90Purchased) { clicks -= 400; clickValue = 10; upgrade400Purchased = true; updateClickerUI(); } });
    
    function updateCharacterPreview() {
        if (!charParts.head) return;

        charParts.headMat.color.set(document.getElementById('head-color').value);
        charParts.torsoMat.color.set(document.getElementById('shirt-color').value);
        charParts.legMat.color.set(document.getElementById('pants-color').value);
        
        charParts.hat.visible = document.getElementById('hat-toggle').checked;

        const url = document.getElementById('face-texture-url').value.trim();
        if (url) {
            textureLoader.load(
                url, 
                function(texture) {
                    const materials = [
                        new THREE.MeshLambertMaterial({ color: charParts.headMat.color }), 
                        new THREE.MeshLambertMaterial({ color: charParts.headMat.color }), 
                        new THREE.MeshLambertMaterial({ color: charParts.headMat.color }), 
                        new THREE.MeshLambertMaterial({ color: charParts.headMat.color }), 
                        new THREE.MeshLambertMaterial({ map: texture }), 
                        new THREE.MeshLambertMaterial({ color: charParts.headMat.color }) 
                    ];
                    charParts.head.material = materials;
                },
                undefined,
                function(err) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—Å—Ç—É—Ä—ã:', err);
                    charParts.head.material = charParts.headMat;
                }
            );
        } else {
             charParts.head.material = charParts.headMat;
        }
    }

    function showMessage(text, duration = 2000) {
        const msg = document.getElementById('interaction-message');
        msg.innerText = text;
        msg.style.display = 'block';
        clearTimeout(msg.timer);
        msg.timer = setTimeout(() => {
            msg.style.display = 'none';
        }, duration);
    }

    function setupFarmControls() {
        document.removeEventListener('keydown', onFarmKeyDown);
        document.removeEventListener('keyup', onFarmKeyUp);
        document.addEventListener('keydown', onFarmKeyDown);
        document.addEventListener('keyup', onFarmKeyUp);
        
        document.getElementById('shop-button').addEventListener('click', () => {
            document.getElementById('shop-modal').style.display = 'block';
            updateFarmHUD();
        });

        if (farmRenderer) farmRenderer.domElement.addEventListener('click', handlePlotInteraction);
    }
    
    function onFarmKeyDown(event) {
        if (!farmControls || farmControls.isLocked !== true) return;
        switch (event.code) {
            case 'ArrowUp': case 'KeyW': moveForward = true; break;
            case 'ArrowLeft': case 'KeyA': moveLeft = true; break;
            case 'ArrowDown': case 'KeyS': moveBackward = true; break;
            case 'ArrowRight': case 'KeyD': moveRight = true; break;
            case 'Space': 
                if (farmCamera.position.y <= 1.5) { 
                    velocity.y += 10;
                }
                break;
        }
    }

    function onFarmKeyUp(event) {
        if (!farmControls || farmControls.isLocked !== true) return;
        switch (event.code) {
            case 'ArrowUp': case 'KeyW': moveForward = false; break;
            case 'ArrowLeft': case 'KeyA': moveLeft = false; break;
            case 'ArrowDown': case 'KeyS': moveBackward = false; break;
            case 'ArrowRight': case 'KeyD': moveRight = false; break;
        }
    }
    
    function handlePlotInteraction() {
        if (!farmControls || farmControls.isLocked !== true) return;
        
        const raycaster = new THREE.Raycaster();
        const coords = new THREE.Vector2(0, 0); 

        raycaster.setFromCamera(coords, farmCamera);
        const intersects = raycaster.intersectObjects(plots);

        if (intersects.length > 0) {
            const plot = intersects[0].object;
            const distance = intersects[0].distance;
            
            if (distance > INTERACTION_RANGE) {
                 showMessage("–°–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ –æ—Ç –≥—Ä—è–¥–∫–∏.", 1000);
                 return;
            }

            const data = plot.userData;

            if (data.growthState === 0) { 
                if (farmInventory[selectedItemToPlant] > 0) {
                    farmInventory[selectedItemToPlant] -= 1;
                    data.planted = selectedItemToPlant;
                    data.growthStart = performance.now();
                    data.growthState = 1;
                    
                    if (plot.userData.plantMesh) farmScene.remove(plot.userData.plantMesh);
                    
                    const item = shopItems[data.planted];
                    const seedGeo = new THREE.SphereGeometry(0.1, 8, 8);
                    const seedMat = new THREE.MeshBasicMaterial({ color: 0xAAAAAA });
                    const seed = new THREE.Mesh(seedGeo, seedMat);
                    seed.position.set(plot.position.x, 0.05, plot.position.z);
                    seed.castShadow = true; 
                    farmScene.add(seed);
                    plot.userData.plantMesh = seed;

                    updateFarmHUD();
                    showMessage(`–ü–æ—Å–∞–∂–µ–Ω–æ ${item.icon} ${item.name}. –í—Ä–µ–º—è —Ä–æ—Å—Ç–∞: ${item.growthTime} —Å–µ–∫.`, 2000);
                } else {
                    showMessage(`–ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å ${shopItems.carrot.icon} ${shopItems.carrot.name} (–∏–ª–∏ –¥—Ä—É–≥–æ–π –ø—Ä–µ–¥–º–µ—Ç) –≤ –º–∞–≥–∞–∑–∏–Ω–µ!`, 2000);
                }
            } else if (data.growthState === 2) { 
                const item = shopItems[data.planted];
                farmInventory[data.planted] += 1; 
                
                farmScene.remove(plot.userData.plantMesh);
                plot.userData.plantMesh = null;
                data.planted = null;
                data.growthStart = null;
                data.growthState = 0; 

                updateFarmHUD();
                showMessage(`–°–æ–±—Ä–∞–Ω–æ ${item.icon} ${item.name}! –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∂–µ.`, 2000);
            } else if (data.growthState === 1) {
                 const item = shopItems[data.planted];
                 const elapsed = (performance.now() - data.growthStart) / 1000;
                 const remaining = Math.max(0, item.growthTime - elapsed).toFixed(1);
                 showMessage(`${item.icon} ${item.name} —Ä–∞—Å—Ç–µ—Ç. –û—Å—Ç–∞–ª–æ—Å—å ${remaining} —Å–µ–∫.`, 1500);
            }
        }
    }
    
    function updateGrowth(delta) {
        plots.forEach(plot => {
            const data = plot.userData;
            if (data.growthState === 1 && data.growthStart) {
                const item = shopItems[data.planted];
                const elapsed = (performance.now() - data.growthStart) / 1000;
                
                if (elapsed >= item.growthTime) {
                    data.growthState = 2; 
                    showMessage(`${item.icon} ${item.name} –≤—ã—Ä–æ—Å! –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å.`, 3000);
                    
                    if (plot.userData.plantMesh) farmScene.remove(plot.userData.plantMesh);
                    
                    let grownGeo, grownMat;
                    if (data.planted === 'carrot') {
                        grownGeo = new THREE.ConeGeometry(0.5, 2, 8);
                        grownMat = new THREE.MeshStandardMaterial({ color: 0xFF8C00 });
                    } else if (data.planted === 'watermelon') {
                        grownGeo = new THREE.SphereGeometry(1, 16, 16);
                        grownMat = new THREE.MeshStandardMaterial({ color: 0x38761D }); 
                    } else {
                        return;
                    }
                    
                    const grownMesh = new THREE.Mesh(grownGeo, grownMat);
                    grownMesh.position.set(plot.position.x, grownGeo.parameters.height / 2, plot.position.z);
                    grownMesh.castShadow = true;
                    farmScene.add(grownMesh);
                    plot.userData.plantMesh = grownMesh;

                } else {
                    if (plot.userData.plantMesh) {
                        const scale = 0.1 + (elapsed / item.growthTime) * 0.9;
                        plot.userData.plantMesh.scale.set(scale, scale, scale);
                    }
                }
            }
        });
    }

    function toggleAdminFly() { 
        isFlying = !isFlying;
        velocity.y = 0; 
        
        const message = document.getElementById('trophy-message');

        if (isFlying) {
            message.innerText = "ADMIN MODE: –ü–û–õ–ï–¢ –ê–ö–¢–ò–í–ò–†–û–í–ê–ù üöÄ";
            message.style.display = 'block';
        } else {
            message.innerText = "ADMIN MODE: –ü–û–õ–ï–¢ –í–´–ö–õ–Æ–ß–ï–ù üõë";
            setTimeout(() => { message.style.display = 'none'; }, 1500); 
        }
    }

    function checkTrophyCollision() { 
        if (!trophy || isFlying) return;

        const playerPos = camera.position;
        const trophyPos = trophy.position;
        
        if (
            playerPos.x > trophyPos.x - 3 && playerPos.x < trophyPos.x + 3 && 
            playerPos.y > trophyPos.y - 5 && playerPos.y < trophyPos.y + 5 &&
            playerPos.z > trophyPos.z - 3 && playerPos.z < trophyPos.z + 3
        ) {
            isFlying = true;
            scene.remove(trophy); 
            document.getElementById('trophy-message').style.display = 'block';
            document.getElementById('trophy-message').innerText = "üèÜ –ü–û–ó–î–†–ê–í–õ–Ø–ï–ú! –†–ï–ñ–ò–ú –ü–û–õ–ï–¢–ê –ê–ö–¢–ò–í–ò–†–û–í–ê–ù! üöÄ";
        }
    }

    function onKeyDown(event) { 
        if (!controls || !controls.isLocked) return;
        switch (event.code) {
            case 'ArrowUp': case 'KeyW': moveForward = true; break;
            case 'ArrowLeft': case 'KeyA': moveLeft = true; break;
            case 'ArrowDown': case 'KeyS': moveBackward = true; break;
            case 'ArrowRight': case 'KeyD': moveRight = true; break;
            case 'Space':
                if (isFlying) { flyUp = true; } 
                else if (canJump) { velocity.y += 250; canJump = false; } 
                break;
            case 'KeyC': if (isFlying) { flyDown = true; } break;
        }
    }

    function onKeyUp(event) { 
        if (!controls || !controls.isLocked) return;
        switch (event.code) {
            case 'ArrowUp': case 'KeyW': moveForward = false; break;
            case 'ArrowLeft': case 'KeyA': moveLeft = false; break;
            case 'ArrowDown': case 'KeyS': moveBackward = false; break;
            case 'ArrowRight': case 'KeyD': moveRight = false; break;
            case 'Space': if (isFlying) flyUp = false; break;
            case 'KeyC': if (isFlying) flyDown = false; break;
        }
    }

    function animate() {
        if (!renderer) return;
        animateId = requestAnimationFrame(animate);

        const time = performance.now();
        const delta = (time - prevTime) / 1000;

        if (rotatingBlock1) rotatingBlock1.rotation.y += 0.02; 
        if (rotatingBlock2) rotatingBlock2.rotation.y += 0.08; 
        if (movingBlock) {
            movingBlock.position.y += movingBlock.userData.direction * 5 * delta;
            if (movingBlock.position.y > movingBlock.userData.startY + 10) movingBlock.userData.direction = -1;
            else if (movingBlock.position.y < movingBlock.userData.startY - 10) movingBlock.userData.direction = 1;
        }
        
        if (controls && controls.isLocked === true) {
            
            if (isFlying) {
                velocity.y = 0; 
                if (flyUp) velocity.y = FLY_SPEED * delta;
                else if (flyDown) velocity.y = -FLY_SPEED * delta;
                else velocity.y = 0; 
                camera.position.y += velocity.y;
            } else {
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
                velocity.y -= 9.8 * 70.0 * delta; 
            }

            direction.z = Number(moveForward) - Number(moveBackward);
            direction.x = Number(moveRight) - Number(moveLeft);
            direction.normalize();

            if (moveForward || moveBackward) velocity.z -= direction.z * 400.0 * delta;
            if (moveLeft || moveRight) velocity.x -= direction.x * 400.0 * delta;

            controls.moveRight(-velocity.x * delta);
            controls.moveForward(-velocity.z * delta);
            
            if (!isFlying) {
                camera.position.y += (velocity.y * delta);
            }

            checkTrophyCollision();

            if (camera.position.y < -25) {
                isFlying = false; 
                velocity.set(0, 0, 0);
                camera.position.set(0, 10, 0); 
                document.getElementById('trophy-message').style.display = 'none';
            } 
            else {
               const p = camera.position;
               platforms.forEach(block => {
                   const bx = block.position.x;
                   const by = block.position.y;
                   const bz = block.position.z;
                   const bw = block.geometry.parameters.width / 2;
                   const bd = block.geometry.parameters.depth / 2;
                   const bh = block.geometry.parameters.height / 2;

                   if (p.x > bx - bw -1 && p.x < bx + bw +1 &&
                       p.z > bz - bd -1 && p.z < bz + bd +1) {
                       
                       if (p.y > by + bh && p.y < by + bh + 3) {
                           if (!isFlying) velocity.y = 0; 
                           p.y = by + bh + 1.8; // Adjusted player height (1.8 instead of 10)
                           canJump = true;
                           
                           if (block === movingBlock && !isFlying) {
                               p.y += movingBlock.userData.direction * 5 * delta;
                           }
                       }
                   }
               });
            }
        } 

        prevTime = time;
        renderer.render(scene, camera);
    }

    function farmAnimate(time) {
        if (!farmRenderer) return;
        farmAnimateId = requestAnimationFrame(farmAnimate);

        const delta = (time - prevTime) / 1000;
        
        if (farmControls && farmControls.isLocked === true) {
            
            velocity.x -= velocity.x * 10.0 * delta;
            velocity.z -= velocity.z * 10.0 * delta;
            velocity.y -= 9.8 * 10.0 * delta; 

            direction.z = Number(moveForward) - Number(moveBackward);
            direction.x = Number(moveRight) - Number(moveLeft);
            direction.normalize();

            if (moveForward || moveBackward) velocity.z -= direction.z * 40.0 * delta;
            if (moveLeft || moveRight) velocity.x -= direction.x * 40.0 * delta;

            farmControls.moveRight(-velocity.x * delta);
            farmControls.moveForward(-velocity.z * delta);
            
            farmCamera.position.y += (velocity.y * delta);
            
            if (farmCamera.position.y < 1.5) {
                velocity.y = 0;
                farmCamera.position.y = 1.5;
            }
            
            updateGrowth(delta);
        }

        farmRenderer.render(farmScene, farmCamera);
        prevTime = time;
    }
    
    function bloggerAnimate(time) {
        if (!bloggerRenderer || currentMode !== 'blogger') return;
        bloggerAnimateId = requestAnimationFrame(bloggerAnimate);

        const delta = (time - prevTime) / 1000;
        
        // Passive Income / Auto-views logic
        if (autoViewsPerSecond > 0) {
            const autoViewsEarned = autoViewsPerSecond * delta;
            views += autoViewsEarned;
            moneyBlogger += autoViewsEarned / 100; // 100 views = $1
            subscribers += Math.floor(autoViewsEarned / 100); // 100 auto-views = 1 subscriber

            // Update UI every 0.5s to prevent flickering
            if (time - lastAutoViewTime > 500) {
                updateBloggerHUD();
                lastAutoViewTime = time;
            }
        }
        
        if (bloggerControls && bloggerControls.isLocked === true) {
            velocity.x -= velocity.x * 10.0 * delta;
            velocity.z -= velocity.z * 10.0 * delta;
            
            // NO GRAVITY in studio
            // velocity.y = 0; 

            direction.z = Number(moveForward) - Number(moveBackward);
            direction.x = Number(moveRight) - Number(moveLeft);
            direction.normalize();

            if (moveForward || moveBackward) velocity.z -= direction.z * 40.0 * delta;
            if (moveLeft || moveRight) velocity.x -= direction.x * 40.0 * delta;

            bloggerControls.moveRight(-velocity.x * delta);
            bloggerControls.moveForward(-velocity.z * delta);
            
            // Player Y stays locked at 1.6m (human height)
            bloggerCamera.position.y = 1.6;
            
            // Simple interaction check for E key hint
            const pc = bloggerScene.getObjectByProperty('userData', 'action');
            if (pc) {
                const camPos = bloggerCamera.position;
                const pcPos = pc.position;
                
                if (camPos.distanceTo(pcPos) < 2.5) {
                    document.getElementById('interaction-message').innerText = "–ù–∞–∂–º–∏—Ç–µ 'E' (–∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –∫–Ω–æ–ø–∫—É) –¥–ª—è —Å—ä–µ–º–∫–∏!";
                } else {
                     document.getElementById('interaction-message').innerText = "WASD –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è. ESC –¥–ª—è –º–µ–Ω—é.";
                }
            }

        }
        
        // Reset player movement flags when controls are unlocked
        if (bloggerControls && bloggerControls.isLocked === false) {
             moveForward = moveBackward = moveLeft = moveRight = false;
        }

        bloggerRenderer.render(bloggerScene, bloggerCamera);
        prevTime = time;
    }
    
    function onWindowResize() { 
        if (camera) {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
        }
        if (renderer) renderer.setSize(window.innerWidth, window.innerHeight);
        
        if (editorCamera) {
            editorCamera.aspect = window.innerWidth / window.innerHeight;
            editorCamera.updateProjectionMatrix();
        }
        if (editorRenderer) editorRenderer.setSize(window.innerWidth, window.innerHeight);

        if (farmCamera) {
            farmCamera.aspect = window.innerWidth / window.innerHeight;
            farmCamera.updateProjectionMatrix();
        }
        if (farmRenderer) farmRenderer.setSize(window.innerWidth, window.innerHeight);

        if (bloggerCamera) { // –ù–û–í–´–ô
            bloggerCamera.aspect = window.innerWidth / window.innerHeight;
            bloggerCamera.updateProjectionMatrix();
        }
        if (bloggerRenderer) bloggerRenderer.setSize(window.innerWidth, window.innerHeight); // –ù–û–í–´–ô
    }

    // --- –ó–ê–ü–£–°–ö ---
    performRegistration();
    showMainMenu(); 
</script>
</body>
</html>